    const header='label,generation_kwh,consumption_kwh,grid_kwh\n'
    const rows=(mode==='DAY' ? (series[0]?.xy||[]).map((p,i)=>{
      const pv=series.find(s=>s.label==='PV')?.xy?.[i]?.y ?? ''
      const ld=series.find(s=>s.label==='Load')?.xy?.[i]?.y ?? ''
      const bt=series.find(s=>s.label==='Battery')?.xy?.[i]?.y ?? ''
      const gr=series.find(s=>s.label==='Grid')?.xy?.[i]?.y ?? ''
      return `${p.x},${pv},${ld},${bt},${gr}`
    }) : agg.map(r=> `${r.label},${r.gen.toFixed(3)},${r.load.toFixed(3)},${r.batt.toFixed(3)},${r.grid.toFixed(3)}`)).join('\n')
    const blob=new Blob([header+rows],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`generation_${mode.toLowerCase()}_${date}.csv`; a.click(); URL.revokeObjectURL(url)
  }

